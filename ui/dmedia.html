<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
body {
    font-family: Ubuntu;
    font-size: 16px;
    background-color: #333;
    color: #e81f3b;
}

.thumb {
    margin: 4px;
    padding: 0;
    overflow: hidden;
    display: inline-block;
    background-position: center center;
    background-size: cover;
    background: #fff;
}

.label  {
    position: absolute;
    overflow: hidden;
    margin: 0;
    padding: 4px;
}

.small div {
    height: 108px;
    width: 108px;
}

.medium div {
    height: 162px;
    width: 162px;
}

.large div {
    height: 216px;
    width: 216px;
}


</style>
<script src="couch.js"></script>
<script src="/_apps/dc3/base.js"></script>
<script>
// The `novacut` CouchDB database:
var db = new couch.Database('dmedia');


function append(parent, doc) {
    var div = $el('div', {'class': 'thumb'});
    if (doc._attachments.thumbnail) {
        var url = db.att_url(doc, 'thumbnail');
        div.style.backgroundImage = 'url("' + url + '")';   
    }
    else {
        div.appendChild($el('div', {textContent: doc.name, 'class': 'label'}));
    }
    parent.appendChild(div);
}


function on_changes(r) {
    var parent = $('hello');
    r['results'].forEach(function(row) {
        var doc = row.doc;
        if (doc.type == 'dmedia/file' && doc.origin == 'user' && doc._attachments.thumbnail) {
            append(parent, doc);
        }
    });
    if (parent.lastChild) {
        parent.lastChild.scrollIntoView();
    }
}

function monitor() {
    var since = db.get().update_seq;
    var m = db.monitor_changes(on_changes, since);
}


function show() {
    var r = db.view('user', 'ctime', {include_docs: true, limit: 500});
    var parent = $('hello');
    r['rows'].forEach(function(row) {
        append(parent, row.doc);
    });
}

</script>
</head>
<body onload="show()">
<div id="hello" class="medium"></div>
</body>
</html>
